{% liquid
  assign product = closest.product
  
  # Check for product tags to determine badge type
  assign show_featured_badge = false
  assign show_ready_to_ship_badge = false
  
  for tag in product.tags
    if tag == 'featured' or tag == 'Featured' or tag == 'FEATURED'
      assign show_featured_badge = true
    elsif tag == 'ready-to-ship' or tag == 'Ready to Ship' or tag == 'READY TO SHIP'
      assign show_ready_to_ship_badge = true
    endif
  endfor
  
  # Get product metafields for custom properties
  assign lead_time = product.metafields.custom.lead_time | default: '3 Weeks'
  assign material = product.metafields.custom.material | default: 'Fabric'
  
  # Build unique color list from variants (prefer variant metafield color/hex, fallback to option value)
  assign _color_csv = ''
  for v in product.variants
    assign v_color = v.metafields.custom.color | default: v.metafields.custom.hex_color | default: v.option1
    if v_color != blank
      unless _color_csv contains v_color
        if _color_csv == ''
          assign _color_csv = v_color
        else
          assign _color_csv = _color_csv | append: '||' | append: v_color
        endif
      endunless
    endif
  endfor
  assign color_values = _color_csv | split: '||'
  assign color_count = color_values.size | default: 0
%}

<style>
  {{ 'custom-product-card-styles.css' | asset_url | stylesheet_tag }}
</style>

<div class="custom-product-card-wrapper" {{ block.shopify_attributes }}>
  <!-- Product Badge -->
  {% if show_featured_badge %}
    <div class="product-badge product-badge--featured">
      FEATURED
    </div>
  {% elsif show_ready_to_ship_badge %}
    <div class="product-badge product-badge--ready-to-ship">
      READY TO SHIP
    </div>
  {% endif %}
  
  <!-- Product Title -->
  <div class="product-title">
    {{ product.title }}
  </div>
  
  <!-- Product Price -->
  <div class="product-price">
    {{ product.price | money }}
  </div>
  
  <!-- Product Image Container -->
  <div class="product-image-container">
    {% if product.featured_image %}
      {{
        product.featured_image
        | image_url: width: 800
        | image_tag: loading: 'lazy', alt: product.title
      }}
    {% else %}
      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
    {% endif %}
    
    <!-- Image Navigation Dots -->
    {% if product.images.size > 1 %}
      <div class="product-image-dots">
        {% for image in product.images limit: 5 %}
          <span class="dot {% if forloop.first %}active{% endif %}"></span>
        {% endfor %}
      </div>
    {% endif %}
  </div>
  
  <!-- Product Info Grid (Lead Time, Color, Material) -->
  <div class="product-info-grid">
    <!-- Lead Time -->
    <div class="product-info-item">
      <div class="product-info-label">Lead Time</div>
      <div class="product-info-value">{{ lead_time }}</div>
    </div>
    
    <!-- Color Swatches -->
    <div class="product-info-item" {% unless color_count > 0 %}style="display:none;"{% endunless %}>
      <div class="product-info-label">Color</div>
      <div class="product-info-value">
        {% if color_count > 0 %}
          <div class="product-color-swatches">
            {% assign max_show = 3 %}
            {% for color in color_values limit: max_show %}
              {% assign safe_color = color | strip %}
              <span class="color-swatch" title="{{ safe_color }}" style="background: {{ safe_color }};"></span>
            {% endfor %}
            {% if color_values.size > max_show %}
              {% assign more = color_values.size | minus: max_show %}
              <span class="color-swatch color-swatch-more">+{{ more }}</span>
            {% endif %}
          </div>
        {% else %}
          <span aria-hidden="true">â€”</span>
        {% endif %}
      </div>
    </div>
    
    <!-- Material -->
    <div class="product-info-item">
      <div class="product-info-label">Material</div>
      <div class="product-info-value">{{ material }}</div>
    </div>
  </div>
  
  <!-- Add to Project Button -->
   {% comment %} <button 
    class="add-to-project-btn"
    onclick="window.location.href='{{ product.url }}'"
    type="button"
  >
    Add to Project
  </button> {% endcomment %}
</div>

{% schema %}
{
  "name": "Custom Product Card",
  "tag": null,
  "settings": [
    {
      "type": "paragraph",
      "content": "This custom product card displays products with badges, lead time, color swatches, and material information. Add 'featured' or 'ready-to-ship' tags to products to show badges. Use product metafields 'custom.lead_time' and 'custom.material' for custom values."
    }
  ]
}
{% endschema %}
