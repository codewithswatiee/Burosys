

{% liquid
  assign product = closest.product
  
  # Check for product tags to determine badge type
  assign show_featured_badge = false
  assign show_ready_to_ship_badge = false

  for tag in product.tags
    if tag == 'featured' or tag == 'Featured' or tag == 'FEATURED'
      assign show_featured_badge = true
    elsif tag == 'ready-to-ship' or tag == 'Ready to Ship' or tag == 'READY TO SHIP' or tag == 'ready_to_ship'
      assign show_ready_to_ship_badge = true
    endif
  endfor

  # Prefer metafield `custom.tag` for badge override when present
  assign badge_metafield = product.metafields.custom.tag | default: ''
  assign badge_class = ''
  assign badge_text = ''
  if badge_metafield != ''
    assign badge_value = badge_metafield | downcase | strip
    if badge_value contains 'featured'
      assign badge_class = 'product-badge--featured'
      assign badge_text = 'FEATURED'
    elsif badge_value contains 'ready'
      assign badge_class = 'product-badge--ready-to-ship'
      assign badge_text = 'READY TO SHIP'
    else
      assign badge_class = 'product-badge--custom'
      assign badge_text = badge_metafield | upcase
    endif
  endif
  
  # Get product metafields for custom properties (no default — show blank if missing)
  assign lead_time = product.metafields.custom.lead_time

  # Build a unique list of color values from variants (prefer variant metafield, fallback to option value)
  assign color_csv = ''
  for v in product.variants
    assign v_color = v.metafields.custom.color | default: v.metafields.custom.hex_color | default: v.option1
    if v_color != blank
      unless color_csv contains v_color
        if color_csv == ''
          assign color_csv = v_color
        else
          assign color_csv = color_csv | append: '||' | append: v_color
        endif
      endunless
    endif
  endfor
  assign color_values = color_csv | split: '||'
  assign material = product.metafields.custom.material | default: 'Fabric'
  
  # (variant option detection removed - not used)
-%}

<style>
  .custom-product-card-wrapper {
    display: flex;
    flex-direction: column;
    border: 1px solid #e5e5e5;
    border-radius: 20px;
    overflow: hidden;
    background: #fff;
    opacity: 1;
    transition: box-shadow 0.3s ease;
    height: auto;
    position: relative;
  }

  .custom-product-card-wrapper:hover {
    border: 1.5px solid #FF4000;
  }

  /* Badge placed over the product image for better visual alignment */
  .product-image-container .product-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    z-index: 20;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.7px;
  }

  /* Badge backgrounds use colored backgrounds for better contrast when using metafield override */
  .product-badge--featured {
    color: #DA2D2D !important;
  }

  .product-badge--ready-to-ship {
    color: #2A24E7 !important;
  }

  .product-badge--custom {
    color: #000;
  }

  .custom-product-card-wrapper .product-title {
    font-size: 16px;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #000;
    margin: 16px 16px 8px 16px;
    text-align: center;
    line-height: 1.4;
    white-space: nowrap;
  }

  .custom-product-card-wrapper .product-price {
    font-size: 16px;
    font-weight: 400;
    color: #6F6F6F;
    margin: 0 16px 12px 16px;
    text-align: center;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .custom-product-card-wrapper .product-image-container {
    position: relative;
    width: 100%;
    height: 320px;
    aspect-ratio: 1/1.3;
    overflow: hidden;
    background: #f9f9f9;
  }

  /* Horizontal scrollable image track */
  .custom-product-card-wrapper .product-image-container {
    position: relative;
    width: 100%;
    height: 320px;
    overflow: hidden;
    background: #f9f9f9;
  }

  .product-image-track {
    display: flex;
    height: 100%;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }

  .product-image-slide {
    flex: 0 0 100%;
    min-width: 100%;
    height: 100%;
    scroll-snap-align: center;
    overflow: hidden;
    position: relative;
  }

  .product-image-slide img {
    width: 100%;
    height: 330px;
    object-fit: cover;
    display: block;
  }

  .product-image-dots {
    position: absolute;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
    z-index: 5;
  }

  .product-image-dots .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.3);
    transition: background-color 0.3s ease;
    cursor: pointer;
  }

  .product-image-dots .dot.active {
    background-color: rgba(0, 0, 0, 0.8);
  }

  /* hide native scrollbar visuals */
  .product-image-track {
    -ms-overflow-style: none; /* IE 10+ */
    scrollbar-width: none; /* Firefox */
  }
  .product-image-track::-webkit-scrollbar { display: none; height: 0; }

  .product-info-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    padding: 12px 16px;
    justify-content: center;
    border-top: 1px solid #e5e5e5;
  }

  .product-info-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  /* Add right border between info items except the last one */
  .product-info-item:not(:last-child) {
    border-right: 0.5px solid #D5D5D5;
    padding-right: 12px;
    box-sizing: border-box;
  }

  .product-info-label {
    font-size: 12px;
    color: #00000099;
    text-transform: capitalize;
    margin-bottom: 8px;
    font-weight: 400;
    white-space: nowrap;
  }

  .product-info-value {
    font-size: 13px;
    color: #000;
    font-weight: 600;
  }

  .product-color-swatches {
    display: flex;
    gap: 6px;
    justify-content: center;
  }

  .color-swatch {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 1px solid #e5e5e5;
    cursor: pointer;
    text-align: center;
    font-size: 9px;
    transition: transform 0.2s ease;
  }

  .color-swatch:hover {
    transform: scale(1.1);
  }

  .color-swatch.brown {
    background-color: #8b6f47;
  }

  .color-swatch.beige, .color-swatch.tan, .color-swatch.cream {
    background-color: #d4a574;
  }

  .color-swatch.blue, .color-swatch.navy {
    background-color: #2563eb;
  }

  .add-to-project-btn {
    width: calc(100% - 32px);
    margin: 12px 16px 16px 16px;
    padding: 12px 24px;
    background-color: #000;
    color: #fff;
    border: none;
    border-radius: 1px;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .add-to-project-btn:hover {
    background-color: #333;
  }

  @media (max-width: 749px) {
    .product-info-grid {
      display: flex !important;
      flex-direction: row !important;
      padding: 10px 5px !important;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .color-swatch{
    font-size: 7px;
  }

    .product-info-label{
      font-size: 7px !important;
    }

    .product-info-value{
      font-size: 8px !important;
    }

    .add-to-project-btn{
      padding: 8px !important;
      margin: 3px !important;
      font-size: 8px !important;

    }

    .custom-product-card-wrapper .product-image-container{
      height: 180px;
    }
    
    .custom-product-card-wrapper .product-title {
      font-size: 12px;
    }
    
    .custom-product-card-wrapper .product-price {
      font-size: 14px;
    }
  }
</style>

<div class="custom-product-card-wrapper" {{ block.shopify_attributes }}>
  <!-- Product Title -->
  <div class="product-title">
    {{ product.title }}
  </div>

  <!-- Product Price -->
  <div class="product-price">
    {{ product.price | money }}
  </div>

  <!-- Product Image Container -->
  <div class="product-image-container">
    <!-- Product Badge (placed over image) -->
    {% if badge_metafield != '' %}
      <div class="product-badge {{ badge_class }}">{{ badge_text }}</div>
    {% endif %}

    <div class="product-image-track">
      {% if product.images.size > 0 %}
        {% for image in product.images %}
          <div class="product-image-slide">
            <a href="{{ product.url }}">
              {{
                image
                | image_url: width: 2400
                | image_tag: loading: 'lazy', alt: product.title
              }}
            </a>
          </div>
        {% endfor %}
      {% else %}
        <div class="product-image-slide">
          {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
        </div>
      {% endif %}
    </div>

    <!-- Image Navigation Dots -->
    {% if product.images.size > 1 %}
      <div class="product-image-dots">
        {% for image in product.images %}
          <span class="dot {% if forloop.first %}active{% endif %}"></span>
        {% endfor %}
      </div>
    {% endif %}
  </div>
  
  <!-- Product Info Grid (Lead Time, Color, Material) -->
  <div class="product-info-grid">
    <!-- Lead Time -->
    <div class="product-info-item" {% if lead_time == blank %}style="display:none;"{% endif %}>
      <div class="product-info-label">Lead Time</div>
      <div class="product-info-value">{{ lead_time }}</div>
    </div>
    
    <!-- Color Swatches -->
    {% assign color_count = color_values.size | default: 0 %}
    <div class="product-info-item" {% unless color_count > 0 %}style="display:none;"{% endunless %}>
      <div class="product-info-label">Color</div>
      <div class="product-info-value">
        {% if color_count > 0 %}
          <div class="product-color-swatches">
            {% assign max_show = 2 %}
            {% for color in color_values limit: max_show %}
              {% assign safe_color = color | strip %}
              <span class="color-swatch" title="{{ safe_color }}" style="background: {{ safe_color }};"></span>
            {% endfor %}
            {% if color_values.size > max_show %}
              {% assign more = color_values.size | minus: max_show %}
              <span class="color-swatch color-swatch-more">+{{ more }}</span>
            {% endif %}
          </div>
        {% else %}
          <span aria-hidden="true">—</span>
        {% endif %}
      </div>
    </div>
    
    <!-- Material -->
    <div class="product-info-item">
      <div class="product-info-label">Material</div>
      <div class="product-info-value">{{ material }}</div>
    </div>
  </div>
  
  <!-- Add to Project Button -->
  {% comment %} <button 
    class="add-to-project-btn"
    onclick="window.location.href='{{ product.url }}'"
    type="button"
  >
    ADD TO PROJECT
  </button> {% endcomment %}
</div>

<script>
  (function(){
    try {
      var script = document.currentScript;
      var wrapper = script && script.parentElement;
      if (!wrapper) return;

      var track = wrapper.querySelector('.product-image-track');
      if (!track) return;
      var slides = Array.prototype.slice.call(wrapper.querySelectorAll('.product-image-slide'));
      var dotsContainer = wrapper.querySelector('.product-image-dots');
      var dots = dotsContainer ? Array.prototype.slice.call(dotsContainer.querySelectorAll('.dot')) : [];

      // ensure dots clickable
      dots.forEach(function(d){ d.setAttribute('role','button'); d.tabIndex = 0; });

      var ticking = false;

      function updateActive(){
        var center = track.scrollLeft + track.clientWidth / 2;
        var closestIndex = 0; var closestDist = Infinity;
        slides.forEach(function(s, i){
          var slideCenter = s.offsetLeft + s.offsetWidth / 2;
          var dist = Math.abs(slideCenter - center);
          if (dist < closestDist) { closestDist = dist; closestIndex = i; }
        });
        dots.forEach(function(dot, i){ dot.classList.toggle('active', i === closestIndex); });
      }

      track.addEventListener('scroll', function(){
        if (!ticking) {
          window.requestAnimationFrame(function(){ updateActive(); ticking = false; });
          ticking = true;
        }
      }, { passive: true });

      // click / key handlers for dots
      dots.forEach(function(dot, i){
        var go = function(e){
          e && e.preventDefault();
          if (!slides[i]) return;
          slides[i].scrollIntoView({ behavior: 'smooth', inline: 'center' });
        };
        dot.addEventListener('click', go);
        dot.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { go(e); } });
      });

      // initial activation
      updateActive();
    } catch (err) {
      console.error('product-card carousel init error', err);
    }
  })();
</script>

{% schema %}
{
  "name": "t:names.product_card",
  "blocks": [
    {
      "type": "_product-card-group"
    },
    {
      "type": "text"
    },
    {
      "type": "image"
    },
    {
      "type": "buy-buttons"
    },
    {
      "type": "price"
    },
    {
      "type": "review"
    },
    {
      "type": "sku"
    },
    {
      "type": "swatches"
    },
    {
      "type": "_product-card-gallery"
    },
    {
      "type": "product-title"
    },
    {
      "type": "custom-liquid"
    },
    {
      "type": "@app"
    }
  ],
  "tag": null,
  "settings": [
    {
      "type": "paragraph",
      "content": "t:content.resource_reference_product_card"
    },
    {
      "type": "range",
      "id": "product_card_gap",
      "label": "t:settings.vertical_gap",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "checkbox",
      "id": "inherit_color_scheme",
      "label": "t:settings.inherit_color_scheme",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1",
      "visible_if": "{{ block.settings.inherit_color_scheme == false }}"
    },
    {
      "type": "header",
      "content": "t:content.borders"
    },
    {
      "type": "select",
      "id": "border",
      "label": "t:settings.style",
      "options": [
        {
          "value": "none",
          "label": "t:options.none"
        },
        {
          "value": "solid",
          "label": "t:options.solid"
        }
      ],
      "default": "none"
    },
    {
      "type": "range",
      "id": "border_width",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "t:settings.thickness",
      "default": 1,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_opacity",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "t:settings.opacity",
      "default": 100,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "t:settings.border_radius",
      "min": 0,
      "max": 32,
      "step": 1,
      "default": 0
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ]
}
{% endschema %}
