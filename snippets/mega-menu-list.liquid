{%- doc -%}
  Renders mega menu list markup and optional featured content.

  @param {object} parent_link - The linklist to render.
  @param {string} id - Unique ID to assign to the `<ul>` element.
  @param {number} [grid_columns_count] - Number of grid columns for the mega menu.
  @param {number} [grid_columns_count_tablet] - Number of grid columns for the mega menu on tablets.
  @param {number} [grid_columns_count_collection_images] - Number of grid columns when `menu_content_type` is 'collection_images'.
  @param {string} [menu_content_type] - Type of content: 'featured_products', 'featured_collections', 'collection_images', or 'text'.
  @param {number} [content_aspect_ratio] - Aspect ratio for content images.
  @param {number} [image_border_radius] - Border radius for content images.
  @param {object} [section] - The section object.

  @example
  {% render 'mega-menu-list', parent_link: link, id: 'MegaMenuList-1', grid_columns_count: 6, menu_content_type: 'featured_products' %}
{%- enddoc -%}

{% liquid
  comment
    open_column_span tracks when a vertical column in the mega menu is open. Links will be stacked
    in the column until the code closes the column span.
  endcomment
  assign open_column_span = false
  assign column_count = 0
  assign links_before_wrap = 10
  assign max_menu_columns = grid_columns_count | default: 6
  assign max_menu_columns_tablet = grid_columns_count_tablet | default: 4

  ##
  # We only eager load heavy elements of the page when rendering this template
  # through the Section Rendering API.
  #
  # This keeps the initial render lightweight, minimizing the impact on TTFB.
  # The second render then refreshes the page with additional content.
  #
  # At the moment, we check if the Section Rendering API is being used by
  # checking if section.index is blank.
  assign eager_loading = false
  if section.index == blank
    assign eager_loading = true
  endif

  if menu_content_type == 'collection_images'
    assign collection_links = parent_link.links | where: 'type', 'collection_link'
    assign catalog_links = parent_link.links | where: 'type', 'catalog_link'
    assign collection_list_links = parent_link.links | where: 'type', 'collections_link'
    if collection_links.size == 0 and catalog_links.size == 0 and collection_list_links.size == 0
      assign menu_content_type = 'text'
    endif
  endif

  if menu_content_type == 'featured_collections'
    if parent_link.type == 'collection_link'
      assign collection_handles = parent_link.object.handle | append: ','
    elsif parent_link.type == 'catalog_link' or parent_link.type == 'collections_link'
      assign collection_handles = 'all' | append: ','
    endif
    assign collection_links = parent_link.links | where: 'type', 'collection_link'
    for collection_link in collection_links
      assign collection_handles = collection_handles | append: collection_link.object.handle | append: ','
    endfor
  endif

  if menu_content_type == 'featured_products'
    if parent_link.type == 'collection_link'
      assign collection_object = parent_link.object
    elsif parent_link.type == 'catalog_link' or parent_link.type == 'collections_link'
      assign collection_object = collections.all
    else
      assign menu_content_type = 'text'
    endif
  endif
%}
<ul
  data-menu-list-id="{{ id }}"
  class="mega-menu__list list-unstyled"
  style="--menu-image-border-radius: {{ image_border_radius }}px;"
>
  {% for link in parent_link.links %}
    {% liquid
      # Decide whether to open a column span, and how many columns of the grid to span
      if forloop.first or open_column_span == false
        assign open_column_span = true

        # Don't allow orphan links in a column
        assign break_after_modulo = link.links.size | modulo: links_before_wrap
        if break_after_modulo == 1
          assign links_before_wrap = links_before_wrap | minus: 1
        endif
        assign break_after_float = links_before_wrap | times: 1.0
        assign column_span = link.links.size | divided_by: break_after_float | ceil | at_least: 1
        assign column_count = column_count | plus: column_span
        assign should_break_columns = true

        if menu_content_type == 'collection_images'
          assign should_break_columns = false
          # For collection image mode, we have an 8-column grid when 4 or fewer parent links are used. Set column span to 2 in that case, otherwise use 1 column
          if parent_link.links.size <= 4
            assign span_class = 'mega-menu__column--wide-collection-image'
          else
            assign span_class = 'mega-menu__column--span-1'
          endif
        else
          # For all other modes, column span is determined by the number of links in the parent link
          assign span_class = 'mega-menu__column--span-' | append: column_span
        endif
        echo '<li class="mega-menu__column ' | append: span_class | append: '">'
      endif
    %}
    <div>
      <div class="mega-menu__parent-link-wrapper" data-parent-wrapper="{{ id }}-{{ forloop.index }}">
        <a
          href="{{ link.url }}"
          class="mega-menu__link {% if link.links != blank %}mega-menu__link--parent{% endif %}"
          {% if link.links != blank %}data-submenu-trigger="{{ id }}-{{ forloop.index }}"{% endif %}
        >
        {% if menu_content_type == 'collection_images' %}
          {%- capture collection_image_sizes -%}
            {%- if parent_link.links.size <= 4 -%}
              {%- assign columns_per_item = 2 -%}
            {%- else -%}
              {%- assign columns_per_item = 1 -%}
            {%- endif -%}
            {%- render 'util-mega-menu-img-sizes-attr',
              menu_content_type: 'collection_images',
              settings: settings,
              grid_columns: grid_columns_count,
              grid_columns_tablet: grid_columns_count_tablet,
              grid_columns_collection_images: grid_columns_count_collection_images,
              parent_links_size: parent_link.links.size,
              columns_per_item: columns_per_item
            -%}
          {%- endcapture -%}

          {% render 'link-featured-image', link: link, class: 'mega-menu__link-image', sizes: collection_image_sizes %}
        {% endif %}
        <span
          class="mega-menu__link-title wrap-text"
        >
          {{- link.title -}}
        </span>
      </a>
      </div>
      {% if link.links != blank and menu_content_type == 'collection_images' %}
        {% comment %} Render child links as image cards (collection images) in full-width submenu {% endcomment %}
        <div class="mega-menu__submenu mega-menu__submenu--collection-cards" data-submenu="{{ id }}-{{ forloop.index }}">
          <button type="button" class="mega-menu__submenu-back" data-submenu-back="{{ id }}-{{ forloop.index }}" aria-label="Back to {{ parent_link.title }}">← Back</button>
          <div class="mega-menu__collection-cards">
            {% for childLink in link.links %}
              {% if childLink.type == 'collection_link' and childLink.object != blank %}
                <a href="{{ childLink.url }}" class="mega-menu__collection-card">
                  <div class="mega-menu__collection-card-media">
                    {% if childLink.object.featured_image %}
                      {{ childLink.object.featured_image | image_url: width: 800 | image_tag: loading: 'lazy', alt: childLink.title }}
                    {% elsif childLink.object.products.size > 0 %}
                      {% assign product_with_image = childLink.object.products | where: 'featured_image' | first %}
                      {% if product_with_image.featured_image %}
                        {{ product_with_image.featured_image | image_url: width: 800 | image_tag: loading: 'lazy', alt: childLink.title }}
                      {% endif %}
                    {% endif %}
                    <div class="mega-menu__collection-card-content">
                      <div class="mega-menu__collection-card-text">
                        <span class="mega-menu__collection-parent">{{ link.title }}</span>
                        <span class="mega-menu__collection-title">{{ childLink.title }}</span>
                      </div>
                      <span class="mega-menu__collection-cta">Discover more</span>
                    </div>
                  </div>
                </a>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% elsif link.links != blank %}
        {% comment %} Render child links as submenu for other menu types {% endcomment %}
        <div class="mega-menu__submenu" data-submenu="{{ id }}-{{ forloop.index }}">
          <button type="button" class="mega-menu__submenu-back" data-submenu-back="{{ id }}-{{ forloop.index }}" aria-label="Back to {{ parent_link.title }}">← Back</button>
          <div class="mega-menu__submenu-grid">
            {% for childLink in link.links %}
              <a href="{{ childLink.url }}" class="mega-menu__link">
                <span class="mega-menu__link-title wrap-text">{{- childLink.title -}}</span>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>

    {% liquid
      # Check conditions for closing the span at the end of each iteration, then close the span if needed
      assign next_linklist = parent_link.links[forloop.index]

      if forloop.last
        assign open_column_span = false
      elsif menu_content_type == 'collection_images'
        assign open_column_span = false
      elsif next_linklist.links != blank
        assign open_column_span = false
      elsif link.links != blank and next_linklist.links == blank
        assign open_column_span = false
      endif

      if open_column_span == false
        echo '</li>'
      endif
    %}
  {% endfor %}
</ul>

{% liquid
  # decide how many grid columns are needed for the menu list, and how many columns are needed for the featured content
  # prioritize a minimum of 1 featured_collection (2 columns), and minimum 2 featured_products (2 columns)
  assign min_products = 2
  assign max_products = 3
  assign min_products_tablet = 1
  assign max_products_tablet = 3
  assign min_collections = 1

  if menu_content_type == 'featured_products'
    # desktop breakpoint
    assign temp_column_count = column_count | plus: min_products

    if temp_column_count > max_menu_columns
      assign max_product_columns = 2
    else
      assign max_product_columns = max_menu_columns | minus: column_count | at_most: max_products
    endif

    if eager_loading
      assign max_product_columns = max_product_columns | at_most: collection_object.products_count
    else
      assign max_product_columns = 0
    endif

    assign max_featured_products = max_product_columns
    assign max_menu_columns = max_menu_columns | minus: max_product_columns

    # tablet breakpoint
    assign temp_column_count = column_count | plus: min_products_tablet

    if temp_column_count > max_menu_columns_tablet
      assign max_product_columns_tablet = 1
    else
      assign max_product_columns_tablet = max_menu_columns_tablet | minus: column_count | at_most: max_products_tablet
    endif

    assign max_product_columns_tablet = max_product_columns_tablet | at_most: max_product_columns

    assign max_featured_products_tablet = max_product_columns_tablet
    assign max_menu_columns_tablet = max_menu_columns_tablet | minus: max_product_columns_tablet
  endif

  if menu_content_type == 'featured_collections'
    # desktop breakpoint
    assign min_featured_collection_columns = min_collections | times: 2
    assign temp_column_count = column_count | plus: min_featured_collection_columns

    if temp_column_count > max_menu_columns
      assign max_collection_columns = 2
    else
      assign max_collection_columns = max_menu_columns | minus: column_count
    endif

    assign max_featured_collections = max_collection_columns | divided_by: 2 | floor
    assign max_menu_columns = max_menu_columns | minus: max_collection_columns

    # tablet breakpoint
    assign max_collection_columns_tablet = 2
    assign max_featured_collections_tablet = 1
    assign max_menu_columns_tablet = max_menu_columns_tablet | minus: max_collection_columns_tablet
  endif
%}

{% style %}
  [data-menu-grid-id="{{ id }}"] {
    {% if menu_content_type == 'collection_images' and parent_link.links.size < 5 %}
      --menu-columns-desktop: {{ grid_columns_count_collection_images }};
      --menu-columns-tablet: {{ grid_columns_count_tablet }};
    {% else %}
      --menu-columns-desktop: {{ grid_columns_count }};
      --menu-columns-tablet: {{ grid_columns_count_tablet }};
    {% endif %}
  }

  [data-menu-list-id="{{ id }}"] {
    {% if menu_content_type == 'collection_images' and parent_link.links.size < 5 %}
      --menu-columns-desktop: {{ grid_columns_count_collection_images }};
      --menu-columns-tablet: {{ max_menu_columns_tablet }};
    {% else %}
      --menu-columns-desktop: {{ max_menu_columns }};
      --menu-columns-tablet: {{ max_menu_columns_tablet }};
    {% endif %}
  }

  /* Collection card submenu - spans full width */
  [data-menu-list-id="{{ id }}"] .mega-menu__submenu--collection-cards {
    display: none;
    padding: 2rem 0;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu--collection-cards.is-active {
    display: block;
  }

  /* Make parent column span full width when collection submenu is active */
  [data-menu-list-id="{{ id }}"] .mega-menu__column:has(.mega-menu__submenu--collection-cards.is-active) {
    grid-column: 1 / -1;
  }

  /* Collection cards grid */
  [data-menu-list-id="{{ id }}"] .mega-menu__collection-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-top: 1rem;
    justify-items: center;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__collection-card {
    display: block;
    color: inherit;
    text-decoration: none;
    border-radius: 16px;
    overflow: hidden;
    background: transparent;
    transition: transform 0.2s ease;
    height: 520px;
    width: 460px;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__collection-card:hover {
    transform: translateY(-4px);
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__collection-card-media {
    position: relative;
    width: 100%;
    border-radius: 16px;
    overflow: hidden;
    height: 100%;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__collection-card-media img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__collection-card-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1.5rem 1.25rem;
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
    color: #fff;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__collection-card-text {
    text-align: center;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__collection-parent {
    display: block;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255,255,255,0.9);
    margin-bottom: 0.25rem;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__collection-title {
    display: block;
    font-style: italic;
    font-size: 62px;
    line-height: 1.2;
    margin-top: 0.25rem;
    margin-bottom: 0.75rem;
    color: #fff;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__collection-cta {
    display: inline-block;
    margin-top: 0.5rem;
    background: #fff;
    border: 1px solid #fff;
    color: #000;
    padding: 15px 18px;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 3px;
    transition: all 0.2s ease;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__collection-card:hover .mega-menu__collection-cta {
    background: transparent;
    color: #fff;
    border-color: #fff;
  }

  @media (max-width: 900px) {
    [data-menu-list-id="{{ id }}"] .mega-menu__collection-cards {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  /* Submenu grid + card styles for other menu types */
  [data-menu-list-id="{{ id }}"] .mega-menu__parent-link-wrapper {
    display: block;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__parent-link-wrapper.is-hidden {
    display: none;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu {
    display: none;
    padding: 1rem 0;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu.is-active {
    display: block;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__column.is-hidden {
    display: none;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-back {
    display: inline-block;
    background: transparent;
    border: 0;
    font-weight: 400;
    font-size: 16px;
    cursor: pointer;
    color: #00000066;
    border-bottom: 1px solid #0000002a;
    transition: all 0.2s ease;
    border-top: 1px solid #0000002d;
    width: 100%;
    text-align: left;
    line-height: 16.5px;
    padding: 10px 0;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-back:hover {
    text-decoration: underline;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-card {
    display: block;
    color: inherit;
    text-decoration: none;
    border-radius: 16px;
    overflow: hidden;
    background: transparent;
    transition: transform 0.2s ease;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-card:hover {
    transform: translateY(-4px);
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-card-media {
    position: relative;
    width: 100%;
    border-radius: 16px;
    overflow: hidden;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-card-media img {
    width: 100%;
    height: 380px;
    object-fit: cover;
    display: block;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-card-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1.5rem 1.25rem;
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
    color: #fff;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-parent {
    display: block;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255,255,255,0.9);
    margin-bottom: 0.25rem;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-title {
    display: block;
    font-style: italic;
    font-size: 1.5rem;
    line-height: 1.2;
    margin-top: 0.25rem;
    margin-bottom: 0.75rem;
    color: #fff;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-cta {
    display: inline-block;
    margin-top: 0.5rem;
    background: #fff;
    border: 1px solid #fff;
    color: #000;
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    transition: all 0.2s ease;
  }

  [data-menu-list-id="{{ id }}"] .mega-menu__submenu-card:hover .mega-menu__submenu-cta {
    background: transparent;
    color: #fff;
    border-color: #fff;
  }

  @media (max-width: 900px) {
    [data-menu-list-id="{{ id }}"] .mega-menu__submenu-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
{% endstyle %}

{% case menu_content_type %}
  {% when 'featured_products' %}
    {%- capture image_sizes -%}
      {%- render 'util-mega-menu-img-sizes-attr',
        menu_content_type: 'featured_products',
        settings: settings,
        grid_columns: grid_columns_count,
        grid_columns_tablet: grid_columns_count_tablet
      -%}
    {%- endcapture -%}

    <span
      class="mega-menu__content"
      style="--menu-content-columns-desktop: {{ max_product_columns }}; --menu-content-columns-tablet: {{ max_product_columns_tablet }}; --resource-card-corner-radius: {{ image_border_radius }}px;"
    >
      <ul
        class="mega-menu__content-list mega-menu__content-list--products list-unstyled"
      >
        {% if eager_loading %}
          {% paginate collection_object.products by max_featured_products %}
            {% for item in collection_object.products %}
              <li class="mega-menu__content-list-item {% if forloop.index > max_featured_products_tablet %} mega-menu__content-list-item--hidden-tablet{% endif %}">
                {% render 'resource-card',
                  resource: item,
                  resource_type: 'product',
                  image_hover: true,
                  image_aspect_ratio: content_aspect_ratio,
                  image_sizes: image_sizes
                %}
              </li>
            {% endfor %}
          {% endpaginate %}
        {% endif %}
      </ul>
    </span>
  {% when 'featured_collections' %}
    {% assign collection_handles = collection_handles | split: ',' | uniq %}
    {%- capture image_sizes -%}
      {%- render 'util-mega-menu-img-sizes-attr',
        menu_content_type: 'featured_collections',
        settings: settings
      -%}
    {%- endcapture -%}

    {% if collection_handles.size == 1 %}
      {% assign max_featured_collections = 1 %}
    {% endif %}

    <span
      class="mega-menu__content"
      style="--menu-content-columns-desktop: {{ max_collection_columns }}; --menu-content-columns-tablet: {{ max_collection_columns_tablet }}; --resource-card-corner-radius: {{ image_border_radius }}px;"
    >
      <ul
        class="mega-menu__content-list mega-menu__content-list--collections list-unstyled"
        style="--menu-content-columns-desktop: {{ max_featured_collections }}; --menu-content-columns-tablet: {{ max_featured_collections_tablet }};"
      >
        {% for handle in collection_handles limit: max_featured_collections %}
          {% if handle == 'all' %}
            {% assign collection_object = collections.all %}
          {% else %}
            {% assign collection_object = collections[handle] %}
          {% endif %}
          <li class="mega-menu__content-list-item{% if forloop.index > max_featured_collections_tablet %} mega-menu__content-list-item--hidden-tablet{% endif %}">
            {% render 'resource-card',
              resource: collection_object,
              resource_type: 'collection',
              style: 'overlay',
              image_aspect_ratio: content_aspect_ratio,
              image_sizes: image_sizes
            %}
          </li>
        {% endfor %}
      </ul>
    </span>
{% endcase %}

<script>
(function() {
  const menuListId = '{{ id }}';
  const menuList = document.querySelector('[data-menu-list-id="' + menuListId + '"]');
  
  if (!menuList) return;

  // Function to recalculate and update the header menu height
  function updateHeaderMenuHeight() {
    const headerMenu = menuList.closest('header-menu');
    if (headerMenu) {
      // Find the currently active submenu within this menu list
      const activeSubmenu = menuList.querySelector('.mega-menu__submenu.is-active');
      
      // Use requestAnimationFrame to ensure DOM has updated before measuring
      requestAnimationFrame(function() {
        let heightToSet;
        
        if (activeSubmenu) {
          // If there's an active submenu, measure its height
          heightToSet = activeSubmenu.scrollHeight;
        } else {
          // Otherwise, measure the entire menu list height
          heightToSet = menuList.scrollHeight;
        }
        
        // Update the CSS variable with the new height
        headerMenu.style.setProperty('--submenu-height', heightToSet + 'px');
      });
    }
  }

  // Handle parent link clicks to show submenu
  menuList.addEventListener('click', function(e) {
    const trigger = e.target.closest('[data-submenu-trigger]');
    if (trigger) {
      e.preventDefault();
      const submenuId = trigger.getAttribute('data-submenu-trigger');
      const submenu = menuList.querySelector('[data-submenu="' + submenuId + '"]');
      const parentColumn = trigger.closest('.mega-menu__column');
      const parentWrapper = menuList.querySelector('[data-parent-wrapper="' + submenuId + '"]');
      
      if (submenu) {
        // Hide all columns except the one with the active submenu
        const allColumns = menuList.querySelectorAll('.mega-menu__column');
        allColumns.forEach(function(col) {
          if (col !== parentColumn) {
            col.classList.add('is-hidden');
          }
        });
        
        // Hide the parent link wrapper
        if (parentWrapper) {
          parentWrapper.classList.add('is-hidden');
        }
        
        // Show the submenu
        submenu.classList.add('is-active');
        
        // Recalculate header menu height after showing submenu
        updateHeaderMenuHeight();
      }
    }
  });

  // Handle back button clicks to hide submenu
  menuList.addEventListener('click', function(e) {
    const backBtn = e.target.closest('[data-submenu-back]');
    if (backBtn) {
      e.preventDefault();
      const submenuId = backBtn.getAttribute('data-submenu-back');
      const submenu = menuList.querySelector('[data-submenu="' + submenuId + '"]');
      const parentWrapper = menuList.querySelector('[data-parent-wrapper="' + submenuId + '"]');
      
      if (submenu) {
        // Hide the submenu
        submenu.classList.remove('is-active');
        
        // Show the parent link wrapper again
        if (parentWrapper) {
          parentWrapper.classList.remove('is-hidden');
        }
        
        // Show all columns again
        const allColumns = menuList.querySelectorAll('.mega-menu__column');
        allColumns.forEach(function(col) {
          col.classList.remove('is-hidden');
        });
        
        // Recalculate header menu height after hiding submenu
        updateHeaderMenuHeight();
      }
    }
  });
})();
</script>
